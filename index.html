<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÄ‡∏Å‡∏°‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏Ñ‡∏¥‡∏î‡πÄ‡∏£‡πá‡∏ß (Speed Math) - Online Mode</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;800&display=swap');
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.3s;
            overscroll-behavior-y: contain; 
            user-select: none;
            -webkit-user-select: none;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            transition: all 0.3s ease-in-out;
        }
        .anim-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 10px;
        }
        .typing-cursor::after {
            content: '|';
            animation: blink 1s step-start infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
        .blink-slow {
            animation: blink-slow 3s infinite ease-in-out;
        }
        @keyframes blink-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,env">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // --- üîí Whitelist ---
        const WHITELISTED_USERS = []; 

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCRmInA68VyblKIESplnclxJEvvPPWN0OE",
            authDomain: "speed-math-game-8af12.firebaseapp.com",
            projectId: "speed-math-game-8af12",
            storageBucket: "speed-math-game-8af12.firebasestorage.app",
            messagingSenderId: "394772873924",
            appId: "1:394772873924:web:4e7c80b5c9e4e644e57f91",
            measurementId: "G-MX28712KBN"
        };

        // Initialize Firebase
        let db, auth;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // --- Audio Manager ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const playTone = (freq, type, duration, vol = 0.1) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        };

        const Sound = {
            click: () => playTone(600, 'triangle', 0.05, 0.05),
            correct: () => {
                playTone(600, 'sine', 0.1, 0.1);
                setTimeout(() => playTone(1200, 'sine', 0.2, 0.1), 100); 
            },
            wrong: () => {
                playTone(150, 'sawtooth', 0.3, 0.1);
                setTimeout(() => playTone(100, 'sawtooth', 0.3, 0.1), 100); 
            },
            gameOver: () => {
                const now = audioCtx.currentTime;
                [523.25, 392.00, 329.63, 261.63].forEach((freq, i) => { 
                    setTimeout(() => playTone(freq, 'triangle', 0.3, 0.1), i * 150);
                });
            },
            ready: () => { 
                playTone(400, 'sine', 0.2, 0.1);
            },
            go: () => { 
                playTone(600, 'sine', 0.1, 0.1);
                setTimeout(() => playTone(880, 'square', 0.4, 0.1), 50);
            },
            flash: () => playTone(800, 'sine', 0.05, 0.05),
            win: () => { 
                const now = audioCtx.currentTime;
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => { 
                    setTimeout(() => playTone(freq, 'sine', 0.2, 0.1), i * 100);
                });
            }
        };

        // --- Helpers ---
        const generateQuestion = (mode = 'normal') => {
            if (mode === 'baby') {
                const ops = ['+', '-'];
                let op, a, b, answer;
                do {
                    op = ops[Math.floor(Math.random() * ops.length)];
                    a = Math.floor(Math.random() * 10);
                    b = Math.floor(Math.random() * 10);
                    if (op === '+') answer = a + b;
                    else {
                        if (a < b) [a, b] = [b, a]; 
                        answer = a - b;
                    }
                } while (answer >= 10);
                return { a, b, op, answer, id: Date.now() };
            }
            if (mode === 'god_2x1') {
                const a = Math.floor(Math.random() * 90) + 10;
                const b = Math.floor(Math.random() * 8) + 2;
                return { a, b, op: '*', answer: a * b, id: Date.now() };
            }
            if (mode === 'god_3x1') {
                const a = Math.floor(Math.random() * 900) + 100;
                const b = Math.floor(Math.random() * 8) + 2;
                return { a, b, op: '*', answer: a * b, id: Date.now() };
            }
            if (mode === 'god_2x2') {
                const a = Math.floor(Math.random() * 90) + 10;
                const b = Math.floor(Math.random() * 90) + 10;
                return { a, b, op: '*', answer: a * b, id: Date.now() };
            }
            if (mode === 'god_div_3x1') {
                const b = Math.floor(Math.random() * 8) + 2;
                const minAns = Math.ceil(100 / b);
                const maxAns = Math.floor(999 / b);
                const ans = Math.floor(Math.random() * (maxAns - minAns + 1)) + minAns;
                const a = ans * b;
                return { a, b, op: '/', answer: ans, id: Date.now() };
            }
            if (mode === 'god_div_4x1') {
                const b = Math.floor(Math.random() * 8) + 2;
                const minAns = Math.ceil(1000 / b);
                const maxAns = Math.floor(9999 / b);
                const ans = Math.floor(Math.random() * (maxAns - minAns + 1)) + minAns;
                const a = ans * b;
                return { a, b, op: '/', answer: ans, id: Date.now() };
            }
            if (mode === 'god_div_4x2') {
                const b = Math.floor(Math.random() * 90) + 10;
                const minAns = Math.ceil(1000 / b);
                const maxAns = Math.floor(9999 / b);
                const ans = Math.floor(Math.random() * (maxAns - minAns + 1)) + minAns;
                const a = ans * b;
                return { a, b, op: '/', answer: ans, id: Date.now() };
            }
            const ops = ['+', '-', '*'];
            const op = ops[Math.floor(Math.random() * ops.length)];
            let a, b;
            if (op === '*') {
                a = Math.floor(Math.random() * 12) + 2;
                b = Math.floor(Math.random() * 9) + 2;
            } else {
                a = Math.floor(Math.random() * 50) + 1;
                b = Math.floor(Math.random() * 50) + 1;
            }
            if (op === '-' && a < b) [a, b] = [b, a];
            const answer = eval(`${a} ${op} ${b}`);
            return { a, b, op, answer, id: Date.now() };
        };

        const generateFlashSequence = (digits, allowNegative, count) => {
            let nums = [];
            let currentSum = 0;
            let min, max;
            if (digits === 1) { min = 1; max = 9; }
            else if (digits === 2) { min = 10; max = 99; }
            else { min = 100; max = 999; }

            for (let i = 0; i < count; i++) {
                let num = Math.floor(Math.random() * (max - min + 1)) + min;
                if (i === 0) {
                    nums.push(num);
                    currentSum += num;
                    continue;
                }
                if (allowNegative) {
                    const isNegative = Math.random() < 0.5;
                    if (isNegative && currentSum - num >= 0) {
                        nums.push(-num);
                        currentSum -= num;
                    } else {
                        nums.push(num);
                        currentSum += num;
                    }
                } else {
                    nums.push(num);
                    currentSum += num;
                }
            }
            return { numbers: nums, answer: currentSum };
        };

        const Timer = ({ duration, onTimeUp, active }) => {
            const [timeLeft, setTimeLeft] = useState(duration);
            useEffect(() => {
                if (!active) return;
                if (timeLeft <= 0) { onTimeUp(); return; }
                const timer = setInterval(() => { setTimeLeft(prev => prev - 1); }, 1000);
                return () => clearInterval(timer);
            }, [timeLeft, active]);
            return (
                <div className={`text-2xl font-bold ${timeLeft < 10 ? 'text-red-500' : 'text-blue-600'}`}>
                    <i className="fa-regular fa-clock mr-2"></i> {timeLeft}s
                </div>
            );
        };

        const getPanelClass = (screenMode) => {
            const base = "glass-panel text-center transition-all duration-300 ";
            switch (screenMode) {
                case 1: return base + "w-full max-w-lg p-4 rounded-xl border-b-2 border-gray-200 shadow-sm";
                case 2: return base + "w-full h-full max-w-none rounded-none p-8 flex flex-col justify-center fixed inset-0 z-40 overflow-y-auto";
                default: return base + "w-full max-w-md p-8 rounded-3xl";
            }
        };

        // --- Navigation Buttons (Left Bar) ---
        const NavigationBar = ({ muted, onToggleMute, inputMode, onToggleInput, onBack, onHome, screenMode, onToggleScreen }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            
            useEffect(() => {
                let timer;
                if (isExpanded) {
                    timer = setTimeout(() => {
                        setIsExpanded(false);
                    }, 5000);
                }
                return () => clearTimeout(timer);
            }, [isExpanded]);
            
            let screenIcon = "fa-expand";
            let screenTitle = "‡∏õ‡∏Å‡∏ï‡∏¥";
            
            if (screenMode === 1) { screenIcon = "fa-arrow-up"; screenTitle = "‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ö‡∏±‡∏á (Compact)"; }
            else if (screenMode === 2) { screenIcon = "fa-arrows-alt-v"; screenTitle = "‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠"; }

            return (
                <div className="absolute top-4 left-4 z-[100] flex flex-col gap-2 items-start">
                    <button 
                        onClick={() => setIsExpanded(!isExpanded)} 
                        className={`w-12 h-12 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center text-xl z-[101] ${isExpanded ? 'bg-gray-800 text-white rotate-180' : 'bg-white text-gray-600 hover:text-blue-500'}`}
                        title="‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤"
                    >
                        <i className={`fa-solid ${isExpanded ? 'fa-xmark' : 'fa-gear'}`}></i>
                    </button>

                    <div className={`flex flex-col gap-3 pl-1 transition-all duration-300 origin-top-left ${isExpanded ? 'opacity-100 scale-100 translate-y-0' : 'opacity-0 scale-0 -translate-y-10 pointer-events-none absolute top-12'}`}>
                        <button onClick={onToggleMute} className="bg-white w-10 h-10 rounded-full shadow-md text-gray-600 hover:text-blue-500 transition hover:scale-110 active:scale-95 flex items-center justify-center" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡πÄ‡∏™‡∏µ‡∏¢‡∏á">
                            {muted ? <i className="fa-solid fa-volume-xmark"></i> : <i className="fa-solid fa-volume-high"></i>}
                        </button>
                        <button onClick={onToggleInput} className="bg-white w-10 h-10 rounded-full shadow-md text-gray-600 hover:text-blue-500 transition hover:scale-110 active:scale-95 flex items-center justify-center" title="‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå">
                            {inputMode === 'numpad' ? <i className="fa-solid fa-hand-pointer"></i> : <i className="fa-regular fa-keyboard"></i>}
                        </button>
                        <button onClick={onToggleScreen} className={`w-10 h-10 rounded-full shadow-md transition hover:scale-110 active:scale-95 flex items-center justify-center ${screenMode === 1 ? 'bg-purple-100 text-purple-600 border-2 border-purple-400' : 'bg-white text-gray-600 hover:text-purple-500'}`} title={screenTitle}>
                            <i className={`fa-solid ${screenIcon}`}></i>
                        </button>
                        <button onClick={onBack} className="bg-white w-10 h-10 rounded-full shadow-md text-gray-600 hover:text-orange-500 transition hover:scale-110 active:scale-95 flex items-center justify-center" title="‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö">
                            <i className="fa-solid fa-arrow-left"></i>
                        </button>
                        <button onClick={onHome} className="bg-white w-10 h-10 rounded-full shadow-md text-gray-600 hover:text-green-500 transition hover:scale-110 active:scale-95 flex items-center justify-center" title="‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å">
                            <i className="fa-solid fa-house"></i>
                        </button>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, playSound, loading }) => {
            const [username, setUsername] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');
                
                if (username.trim()) {
                    if (WHITELISTED_USERS.length > 0 && !WHITELISTED_USERS.includes(username.trim())) {
                        playSound('wrong');
                        setError('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô');
                        return;
                    }
                    playSound('click'); 
                    onLogin(username.trim()); 
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 anim-pop relative">
                    <div className="glass-panel p-8 rounded-3xl w-full max-w-sm">
                        <div className="text-center mb-6">
                            <div className="text-5xl text-blue-500 mb-2"><i className="fa-solid fa-gamepad"></i></div>
                            <h2 className="text-2xl font-bold text-gray-800">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏•‡∏¢!</h2>
                            <p className="text-xs text-gray-400 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Global)</p>
                        </div>
                        {error && <div className="mb-4 p-2 bg-red-100 text-red-600 text-sm rounded-lg text-center border border-red-200">{error}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-gray-700 text-sm font-bold mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                                <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full p-3 rounded-xl border border-gray-300 focus:border-blue-500 outline-none transition" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô..." required />
                            </div>
                            <button type="submit" disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transform transition hover:scale-105">
                                {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...' : '‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°'}
                            </button>
                        </form>
                    </div>
                    <div className="absolute bottom-6 w-full text-center text-sm text-gray-500 blink-slow font-medium">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ KF</div>
                </div>
            );
        };

        const Countdown = ({ onComplete, playSound }) => {
            const [step, setStep] = useState('ready'); 
            useEffect(() => {
                playSound('ready');
                const timer1 = setTimeout(() => { setStep('go'); playSound('go'); }, 1500); 
                const timer2 = setTimeout(() => { onComplete(); }, 2500); 
                return () => { clearTimeout(timer1); clearTimeout(timer2); };
            }, []);
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-yellow-50 p-4 fixed inset-0 z-50">
                    <div className={`text-7xl md:text-9xl font-black transition-all duration-300 transform drop-shadow-lg ${step === 'ready' ? 'text-orange-500 animate-pulse scale-100' : 'text-green-500 scale-125 animate-bounce'}`}>
                        {step === 'ready' ? 'READY?' : 'GO!!'}
                    </div>
                </div>
            );
        };

        const GodFlashSettings = ({ onStart, playSound, screenMode }) => {
            const [digits, setDigits] = useState(1);
            const [allowNegative, setAllowNegative] = useState(false);
            const [count, setCount] = useState(5);
            const [speed, setSpeed] = useState(1000);
            const [numQuestions, setNumQuestions] = useState(5);

            const handleStart = () => { playSound('click'); onStart({ digits, allowNegative, count, speed, numQuestions }); };
            const SettingButton = ({ selected, onClick, label }) => (
                <button onClick={() => { playSound('click'); onClick(); }} className={`px-3 py-1 rounded-full text-sm font-bold border-2 transition whitespace-nowrap ${selected ? 'bg-purple-500 text-white border-purple-500' : 'bg-white text-gray-500 border-gray-200'}`}>{label}</button>
            );

            const containerClass = screenMode === 2 
                ? "w-full h-full max-w-none rounded-none p-8 flex flex-col justify-center fixed inset-0 z-40 overflow-y-auto glass-panel"
                : "glass-panel p-6 rounded-3xl w-full max-w-md relative max-h-[90vh] overflow-y-auto custom-scroll";

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 anim-pop">
                    <div className={containerClass}>
                        <h2 className="text-2xl font-bold text-center text-purple-600 mb-6 mt-2">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏û‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å-‡∏•‡∏ö ‚ö°</h2>
                        <div className="space-y-4">
                            <div><label className="block text-gray-700 text-sm font-bold mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å</label><div className="flex flex-wrap gap-2">{[1, 2, 3].map(d => <SettingButton key={d} selected={digits === d} onClick={() => setDigits(d)} label={`${d} ‡∏´‡∏•‡∏±‡∏Å`} />)}</div></div>
                            <div><label className="block text-gray-700 text-sm font-bold mb-2">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå</label><div className="flex gap-2"><SettingButton selected={!allowNegative} onClick={() => setAllowNegative(false)} label="‡∏ö‡∏ß‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß" /><SettingButton selected={allowNegative} onClick={() => setAllowNegative(true)} label="‡∏ö‡∏ß‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡∏ö" /></div></div>
                            <div><label className="block text-gray-700 text-sm font-bold mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠)</label><div className="flex flex-wrap gap-2">{[3, 5, 7, 10, 15, 20, 30].map(c => <SettingButton key={c} selected={count === c} onClick={() => setCount(c)} label={c} />)}</div></div>
                            <div><label className="block text-gray-700 text-sm font-bold mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)</label><div className="flex flex-wrap gap-2">{[1000, 800, 550, 450, 350, 250].map(s => <SettingButton key={s} selected={speed === s} onClick={() => setSpeed(s)} label={s} />)}</div></div>
                            <div><label className="block text-gray-700 text-sm font-bold mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô</label><div className="flex flex-wrap gap-2">{[1, 3, 5, 10].map(q => <SettingButton key={q} selected={numQuestions === q} onClick={() => setNumQuestions(q)} label={`${q} ‡∏Ç‡πâ‡∏≠`} />)}</div></div>
                            <button onClick={handleStart} className="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 rounded-xl shadow-lg mt-4 transform transition hover:scale-105">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏¢!</button>
                        </div>
                    </div>
                </div>
            );
        };

        const GodFlashGame = ({ settings, onQuit, playSound, inputMode, screenMode }) => {
            const [sequence, setSequence] = useState([]);
            const [answer, setAnswer] = useState(0);
            const [phase, setPhase] = useState('preparing'); 
            const [currentIndex, setCurrentIndex] = useState(-1);
            const [showNumber, setShowNumber] = useState(false);
            const [input, setInput] = useState('');
            const [resultMsg, setResultMsg] = useState('');
            const [currentRound, setCurrentRound] = useState(1);
            const [totalScore, setTotalScore] = useState(0);
            const inputRef = useRef(null);

            // --- 1. Init Round Data ---
            const initRound = () => {
                const { numbers, answer } = generateFlashSequence(settings.digits, settings.allowNegative, settings.count);
                setSequence(numbers);
                setAnswer(answer);
                // Switch to round_countdown instead of flashing directly
                setPhase('round_countdown'); 
                setCurrentIndex(-1);
                setInput('');
                setShowNumber(false);
            };

            // --- 2. Effect triggers only on round change ---
            useEffect(() => {
                initRound();
            }, [currentRound]);

            // --- 3. Actual Flashing Logic (Called after countdown) ---
            const startFlashing = () => {
                setPhase('flashing');
                let index = 0;
                const interval = setInterval(() => {
                    if (index >= sequence.length) { 
                        clearInterval(interval); 
                        setPhase('input'); 
                        return; 
                    }
                    
                    setCurrentIndex(index);
                    setShowNumber(true);
                    playSound('flash');

                    const hideTime = Math.min(settings.speed / 2, 200); 
                    setTimeout(() => { setShowNumber(false); }, settings.speed - hideTime);
                    index++;
                }, settings.speed);
            };

            // --- Key Listener for Next Round ---
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'Enter' && phase === 'result' && inputMode === 'keyboard') {
                        handleNextRound();
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [phase, inputMode, currentRound, settings.numQuestions]); // Add dependencies

            const handleSubmit = (e) => {
                if(e) e.preventDefault();
                const val = parseInt(input);
                if (isNaN(val)) return;
                if (val === answer) { playSound('correct'); setResultMsg('‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ üéâ'); setTotalScore(prev => prev + 1); } 
                else { playSound('wrong'); setResultMsg(`‡∏ú‡∏¥‡∏î‡∏à‡πâ‡∏≤! ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏≠ ${answer} üò¢`); }
                setPhase('result');
            };

            const handleNextRound = () => {
                playSound('click');
                if (currentRound < settings.numQuestions) { setCurrentRound(prev => prev + 1); } 
                else { playSound('win'); setPhase('summary'); }
            };

            const handleNumpad = (num) => {
                playSound('click');
                if (num === 'C') setInput(''); else setInput(prev => prev + num);
                if (inputMode === 'keyboard' && inputRef.current) inputRef.current.focus();
            };

            const isCompact = screenMode === 1;
            const containerStyle = isCompact ? "justify-start pt-4" : "justify-center";
            const spacingStyle = isCompact ? "mb-2" : "mb-8";
            const numberSize = isCompact ? "text-7xl h-32" : "text-9xl h-40";

            // Render Countdown for Every Round
            if (phase === 'round_countdown') {
                return <Countdown onComplete={startFlashing} playSound={playSound} />;
            }

            if (phase === 'flashing') return <div className={`flex flex-col items-center min-h-screen bg-purple-50 p-4 ${containerStyle}`}><div className="absolute top-4 right-4 text-purple-400 font-bold bg-white px-3 py-1 rounded-full shadow">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà {currentRound} / {settings.numQuestions}</div><div className={`text-gray-400 font-bold ${spacingStyle} text-xl`}>‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà {currentIndex + 1} / {settings.count}</div><div className={`${numberSize} font-black text-purple-600 drop-shadow-lg flex items-center justify-center`}>{showNumber && sequence[currentIndex] !== undefined ? <span className="anim-pop">{sequence[currentIndex]}</span> : <span></span>}</div></div>;
            
            if (phase === 'input') return <div className={`flex flex-col items-center min-h-screen bg-purple-50 px-4 ${isCompact ? 'pt-4 justify-start' : 'pt-8'}`}><div className="absolute top-4 right-4 text-purple-400 font-bold bg-white px-3 py-1 rounded-full shadow">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà {currentRound} / {settings.numQuestions}</div><div className={`w-full max-w-lg text-center ${isCompact ? 'mt-4 mb-2' : 'mt-8 mb-8'}`}><h2 className={`font-bold text-purple-600 animate-bounce ${isCompact ? 'text-2xl mb-1' : 'text-4xl mb-4'}`}>‡∏ï‡∏≠‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?</h2></div><div className={`${getPanelClass(screenMode)} mb-6 shadow-xl`}>{inputMode === 'numpad' ? <div className={`w-full bg-gray-100 text-center font-bold p-4 rounded-xl border-2 border-purple-300 flex items-center justify-center ${isCompact ? 'text-3xl h-16' : 'text-4xl h-20'}`}>{input}<span className="animate-pulse text-gray-400 font-light text-3xl ml-1">|</span></div> : <form onSubmit={handleSubmit} className="w-full"><input ref={inputRef} type="number" pattern="[0-9]*" inputMode="numeric" value={input} onChange={(e) => setInput(e.target.value)} className={`w-full bg-gray-100 text-center font-bold p-4 rounded-xl border-2 border-purple-300 focus:bg-white outline-none ${isCompact ? 'text-3xl h-16' : 'text-4xl h-20'}`} placeholder="?" autoFocus /><button type="submit" className="hidden">Submit</button></form>}</div><div className="w-full max-w-lg grid grid-cols-3 gap-2 mt-auto">{[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0].map((num) => <button key={num} onClick={() => handleNumpad(num)} className={`rounded-xl font-bold shadow-sm active:scale-95 transition ${num === 'C' ? 'bg-red-100 text-red-500' : 'bg-white text-gray-700 hover:bg-gray-50'} ${isCompact ? 'p-3 text-xl' : 'p-4 text-2xl'}`}>{num}</button>)}<button onClick={() => handleSubmit()} className={`rounded-xl font-bold shadow-sm active:scale-95 transition text-white bg-purple-500 ${isCompact ? 'p-3 text-xl' : 'p-4 text-2xl'}`}><i className="fa-solid fa-paper-plane"></i></button></div></div>;
            
            if (phase === 'result') return <div className="flex flex-col items-center justify-center min-h-screen p-4 anim-pop"><div className={`${getPanelClass(screenMode)} border-t-4 border-purple-500`}><h2 className="text-3xl font-bold text-gray-800 mb-4">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡∏Ç‡πâ‡∏≠ {currentRound})</h2><div className="text-xl mb-6 font-bold text-purple-600">{resultMsg}</div><div className="bg-gray-50 p-4 rounded-xl mb-6 text-sm text-gray-500 text-left max-h-40 overflow-y-auto custom-scroll"><div className="font-bold mb-2 text-center">‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á:</div><div className="flex flex-wrap gap-2 justify-center">{sequence.map((n, i) => <span key={i} className="bg-white px-2 py-1 rounded border shadow-sm">{n > 0 && i > 0 ? `+${n}` : n}</span>)}</div><div className="mt-2 text-center font-bold text-lg">= {answer}</div></div><button onClick={handleNextRound} className="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-2xl shadow-lg animate-pulse">{currentRound < settings.numQuestions ? '‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚ñ∂' : '‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• üìä'}</button></div></div>;
            
            if (phase === 'summary') {
                const percent = (totalScore / settings.numQuestions) * 100;
                let feedbackText = "";
                if (percent >= 80) feedbackText = "‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏¢! ‡πÄ‡∏ó‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏ä‡∏±‡∏î‡πÜ üèÜ";
                else if (percent >= 50) feedbackText = "‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß üëç";
                else feedbackText = "‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£‡∏ô‡∏∞ ‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Å‡πá‡πÄ‡∏Å‡πà‡∏á! ‚úåÔ∏è";
                return <div className="flex flex-col items-center justify-center min-h-screen p-4 anim-pop"><div className={`${getPanelClass(screenMode)} border-4 border-yellow-400`}><div className="text-6xl mb-4 text-purple-500"><i className="fa-solid fa-star"></i></div><h2 className="text-4xl font-bold text-gray-800 mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2><div className="text-6xl font-black text-purple-600 mb-4">{totalScore} / {settings.numQuestions}</div><div className="text-lg text-gray-600 mb-8 font-medium">{feedbackText}</div><button onClick={onQuit} className="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-2xl shadow-lg"><i className="fa-solid fa-home mr-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button></div></div>;
            }
            return null;
        };

        const Leaderboard = ({ currentUser, screenMode }) => {
            const [scores, setScores] = useState([]);
            const [viewMode, setViewMode] = useState('normal'); 
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                setLoading(true);
                let modeDoc = 'normal'; 
                if (viewMode === 'baby') modeDoc = 'baby';
                else if (viewMode === 'god_2x1') modeDoc = 'god_2x1';
                else if (viewMode === 'god_3x1') modeDoc = 'god_3x1';
                else if (viewMode === 'god_2x2') modeDoc = 'god_2x2';
                else if (viewMode === 'god_div_3x1') modeDoc = 'god_div_3x1';
                else if (viewMode === 'god_div_4x1') modeDoc = 'god_div_4x1';
                else if (viewMode === 'god_div_4x2') modeDoc = 'god_div_4x2';
                
                const unsubscribe = db.collection('modes').doc(modeDoc).collection('scores')
                    .orderBy('score', 'desc')
                    .limit(20)
                    .onSnapshot((snapshot) => {
                        const loadedScores = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                        setScores(loadedScores);
                        setLoading(false);
                    }, (error) => {
                        console.error("Error getting leaderboard:", error);
                        setLoading(false);
                    });
                
                return () => unsubscribe();
            }, [viewMode]);

            const getModeLabel = (m) => {
                 if (m === 'normal') return '‡∏õ‡∏Å‡∏ï‡∏¥'; if (m === 'baby') return 'Baby'; if (m === 'god_2x1') return '‡πÄ‡∏ó‡∏û‡∏Ñ‡∏π‡∏ì 2x1'; if (m === 'god_3x1') return '‡πÄ‡∏ó‡∏û‡∏Ñ‡∏π‡∏ì 3x1'; if (m === 'god_2x2') return '‡πÄ‡∏ó‡∏û‡∏Ñ‡∏π‡∏ì 2x2'; if (m === 'god_div_3x1') return '‡πÄ‡∏ó‡∏û‡∏´‡∏≤‡∏£ 3/1'; if (m === 'god_div_4x1') return '‡πÄ‡∏ó‡∏û‡∏´‡∏≤‡∏£ 4/1'; if (m === 'god_div_4x2') return '‡πÄ‡∏ó‡∏û‡∏´‡∏≤‡∏£ 4/2'; return m;
            };

            const formatTimestamp = (ts) => {
                if (!ts) return '-';
                try {
                    const date = ts.toDate ? ts.toDate() : new Date(ts);
                    return date.toLocaleString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    return '-';
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 anim-pop">
                    <div className={`${getPanelClass(screenMode)} h-[85vh] flex flex-col relative`}>
                        <div className="mb-4 mt-2 relative shrink-0">
                            <h2 className="text-3xl font-bold text-center text-yellow-500"><i className="fa-solid fa-trophy mr-2"></i>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</h2>
                        </div>
                        <div className="flex flex-1 overflow-hidden gap-3">
                            <div className="w-1/3 min-w-[100px] flex flex-col gap-2 overflow-y-auto custom-scroll pr-1 pb-2">
                                {['normal', 'baby', 'god_2x1', 'god_3x1', 'god_2x2', 'god_div_3x1', 'god_div_4x1', 'god_div_4x2'].map(m => (
                                    <button key={m} onClick={() => setViewMode(m)} className={`px-3 py-3 rounded-xl text-sm font-bold transition text-left shadow-sm leading-tight ${viewMode === m ? 'bg-blue-500 text-white ring-2 ring-blue-300' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{getModeLabel(m)}</button>
                                ))}
                            </div>
                            <div className="flex-1 overflow-y-auto custom-scroll bg-gray-50 rounded-xl p-2 shadow-inner">
                                {loading ? <div className="text-center text-gray-400 mt-10"><i className="fa-solid fa-circle-notch fa-spin mb-2"></i><br/>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div> : scores.length === 0 ? <div className="text-center text-gray-400 mt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div> : <table className="w-full text-left border-collapse"><thead className="sticky top-0 bg-gray-50 z-10"><tr className="text-gray-400 text-xs border-b border-gray-200"><th className="py-2 px-1 font-light">#</th><th className="py-2 px-1 font-light">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</th><th className="py-2 px-1 font-light text-right">‡πÅ‡∏ï‡πâ‡∏°</th></tr></thead><tbody>{scores.map((s, index) => {const isMe = currentUser && s.username === currentUser.displayName; return (<tr key={index} className={`border-b border-gray-100 last:border-0 text-sm ${isMe ? 'bg-yellow-100 rounded' : ''}`}><td className="py-2 px-1 font-bold text-gray-500">{index + 1}</td><td className={`py-2 px-1 ${isMe ? 'text-blue-600' : 'text-gray-700'}`}><div className="font-semibold truncate max-w-[100px]">{s.username} {isMe && '(‡∏Ñ‡∏∏‡∏ì)'}</div><div className="text-xs text-gray-400 font-light">{formatTimestamp(s.timestamp)}</div></td><td className="py-2 px-1 text-right font-bold text-blue-500">{s.score}</td></tr>);})}</tbody></table>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const MainMenu = ({ onStartSingle, onShowLeaderboard, onLogout, username, playSound, onStartFlash, screenMode }) => {
            const [subMenu, setSubMenu] = useState(null);
            const handleStart = (mode) => { playSound('click'); onStartSingle(mode); };
            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 anim-pop">
                    <div className={`${getPanelClass(screenMode)} border-b-4 border-blue-200 relative`}>
                        <div className="absolute top-4 right-4 flex flex-col items-end">
                             <span className="text-xs text-gray-400">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</span>
                             <span className="text-sm font-bold text-blue-600">{username}</span>
                        </div>
                        <div className="text-6xl mb-4 text-yellow-400 drop-shadow-md mt-6 hover:scale-110 transition cursor-pointer" onClick={() => playSound('correct')}><i className="fa-solid fa-brain"></i></div>
                        <h1 className="text-4xl font-extrabold text-gray-800 mb-2">Speed Math</h1>
                        <p className="text-gray-500 mb-8">‡∏õ‡∏£‡∏∞‡∏•‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á ‡∏õ‡∏£‡∏∞‡∏•‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</p>

                        {!subMenu ? (
                            <>
                                <button onClick={() => handleStart('normal')} className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition hover:scale-105 mb-3 text-xl"><i className="fa-solid fa-bolt mr-2"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏õ‡∏Å‡∏ï‡∏¥)</button>
                                <button onClick={() => handleStart('baby')} className="w-full bg-pink-400 hover:bg-pink-500 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition hover:scale-105 mb-3 text-xl"><i className="fa-solid fa-baby mr-2"></i> Baby Mode üë∂</button>
                                <button onClick={() => { playSound('click'); setSubMenu('god_mult'); }} className="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition hover:scale-105 mb-3 text-xl border-b-4 border-yellow-700"><i className="fa-solid fa-crown mr-2"></i> ‡πÄ‡∏ó‡∏û‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏ì ‚ö°</button>
                                <button onClick={() => { playSound('click'); setSubMenu('god_div'); }} className="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition hover:scale-105 mb-3 text-xl border-b-4 border-teal-700"><i className="fa-solid fa-divide mr-2"></i> ‡πÄ‡∏ó‡∏û‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£ ‚ûó</button>
                                <button onClick={() => { playSound('click'); onStartFlash(); }} className="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition hover:scale-105 mb-3 text-xl border-b-4 border-purple-700"><i className="fa-solid fa-eye mr-2"></i> ‡πÄ‡∏ó‡∏û‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å-‡∏•‡∏ö (Flash) üëÅÔ∏è</button>
                                <button onClick={() => { playSound('click'); onShowLeaderboard(); }} className="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-2xl shadow transform transition hover:scale-105 mb-3 text-lg"><i className="fa-solid fa-trophy mr-2"></i> ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö (‡πÇ‡∏•‡∏Å)</button>
                            </>
                        ) : subMenu === 'god_mult' ? (
                            <div className="space-y-3 mb-4 animate-[pop_0.3s_ease-out]">
                                <h3 className="text-yellow-600 font-bold text-lg mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡∏û (‡∏Ñ‡∏π‡∏ì)</h3>
                                <button onClick={() => handleStart('god_2x1')} className="w-full bg-orange-400 hover:bg-orange-500 text-white font-bold py-3 px-6 rounded-xl shadow-md">2 ‡∏´‡∏•‡∏±‡∏Å √ó 1 ‡∏´‡∏•‡∏±‡∏Å</button>
                                <button onClick={() => handleStart('god_3x1')} className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-xl shadow-md">3 ‡∏´‡∏•‡∏±‡∏Å √ó 1 ‡∏´‡∏•‡∏±‡∏Å</button>
                                <button onClick={() => handleStart('god_2x2')} className="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-md border-b-4 border-red-800">2 ‡∏´‡∏•‡∏±‡∏Å √ó 2 ‡∏´‡∏•‡∏±‡∏Å üî•</button>
                                <button onClick={() => { playSound('click'); setSubMenu(null); }} className="text-gray-400 hover:text-gray-600 text-sm mt-2"><i className="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö</button>
                            </div>
                        ) : (
                            <div className="space-y-3 mb-4 animate-[pop_0.3s_ease-out]">
                                <h3 className="text-teal-600 font-bold text-lg mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡∏û (‡∏´‡∏≤‡∏£)</h3>
                                <button onClick={() => handleStart('god_div_3x1')} className="w-full bg-teal-400 hover:bg-teal-500 text-white font-bold py-3 px-6 rounded-xl shadow-md">3 ‡∏´‡∏•‡∏±‡∏Å √∑ 1 ‡∏´‡∏•‡∏±‡∏Å</button>
                                <button onClick={() => handleStart('god_div_4x1')} className="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-xl shadow-md">4 ‡∏´‡∏•‡∏±‡∏Å √∑ 1 ‡∏´‡∏•‡∏±‡∏Å</button>
                                <button onClick={() => handleStart('god_div_4x2')} className="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-xl shadow-md border-b-4 border-cyan-800">4 ‡∏´‡∏•‡∏±‡∏Å √∑ 2 ‡∏´‡∏•‡∏±‡∏Å üî•</button>
                                <button onClick={() => { playSound('click'); setSubMenu(null); }} className="text-gray-400 hover:text-gray-600 text-sm mt-2"><i className="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö</button>
                            </div>
                        )}

                        <button onClick={() => { playSound('click'); onLogout(); }} className="text-gray-400 hover:text-red-500 text-sm underline mt-4">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
                        <div className="w-full text-right mt-4"><span className="text-xs text-gray-400 blink-slow font-light">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ KF</span></div>
                    </div>
                </div>
            );
        };

        const GameScreen = ({ question, score, onAnswer, onQuit, timeUp, mode, playSound, inputMode, screenMode }) => {
            const [input, setInput] = useState('');
            const [feedback, setFeedback] = useState(null); 
            const inputRef = useRef(null);
            useEffect(() => { if (inputMode === 'keyboard' && inputRef.current) inputRef.current.focus(); }, [question, inputMode]);
            const handleSubmit = (e) => {
                if (e) e.preventDefault();
                const val = parseInt(input); if (isNaN(val)) return;
                if (val === question.answer) { playSound('correct'); setFeedback('correct'); onAnswer(true); } 
                else { playSound('wrong'); setFeedback('wrong'); onAnswer(false); }
                setInput(''); setTimeout(() => setFeedback(null), 500);
            };
            const handleNumpad = (num) => {
                playSound('click'); if (num === 'C') setInput(''); else setInput(prev => prev + num);
                if (inputMode === 'keyboard' && inputRef.current) inputRef.current.focus();
            };
            const isGodMult = mode.startsWith('god') && !mode.includes('div'); const isGodDiv = mode.startsWith('god_div'); const isBabyMode = mode === 'baby';
            let modeLabel = ''; if (isBabyMode) modeLabel = 'BABY MODE'; if (mode === 'god_2x1') modeLabel = 'GOD MUL 2x1'; if (mode === 'god_3x1') modeLabel = 'GOD MUL 3x1'; if (mode === 'god_2x2') modeLabel = 'GOD MUL 2x2'; if (mode === 'god_div_3x1') modeLabel = 'GOD DIV 3/1'; if (mode === 'god_div_4x1') modeLabel = 'GOD DIV 4/1'; if (mode === 'god_div_4x2') modeLabel = 'GOD DIV 4/2';
            const getThemeColors = () => { if (isBabyMode) return { bg: 'bg-pink-50', text: 'text-pink-500', border: 'border-pink-400', ring: 'focus:border-pink-400', score: 'text-pink-500', btn: 'bg-pink-400' }; if (isGodMult) return { bg: 'bg-orange-50', text: 'text-orange-500', border: 'border-orange-500', ring: 'focus:border-orange-500', score: 'text-orange-600', btn: 'bg-orange-500' }; if (isGodDiv) return { bg: 'bg-teal-50', text: 'text-teal-500', border: 'border-teal-500', ring: 'focus:border-teal-500', score: 'text-teal-600', btn: 'bg-teal-500' }; return { bg: 'bg-blue-50', text: 'text-blue-500', border: 'border-blue-500', ring: 'focus:border-blue-500', score: 'text-blue-600', btn: 'bg-blue-500' }; };
            const theme = getThemeColors();

            // Compact Mode Adjustments (Keyboard Friendly)
            const isCompact = screenMode === 1;
            const containerStyle = isCompact ? `pt-2 justify-start h-[100dvh]` : `min-h-screen pt-8 justify-between`; // Use dvh for mobile fix
            const headerStyle = isCompact ? "mb-2 scale-90" : "mb-8";
            const panelStyle = isCompact ? "mb-2 py-4" : "mb-6 py-8";
            const fontScale = isCompact ? "scale-90 origin-top" : ""; // Scale down question slightly
            const numpadStyle = isCompact ? "mt-2" : "mt-auto";

            return (
                <div className={`flex flex-col items-center px-4 transition-colors duration-500 ${theme.bg} ${feedback === 'correct' ? 'bg-green-100' : feedback === 'wrong' ? 'bg-red-100' : ''} ${containerStyle}`}>
                    
                    {/* Header */}
                    <div className={`w-full max-w-lg flex justify-between items-center ${headerStyle} transition-all`}>
                        <div className="w-10"></div>
                        <div className="bg-white px-6 py-2 rounded-full shadow-sm flex items-center gap-2">
                             {modeLabel && <span className={`text-sm font-bold ${theme.text}`}>{modeLabel}</span>}
                            <Timer duration={60} onTimeUp={timeUp} active={true} />
                        </div>
                        <button onClick={() => { playSound('click'); onQuit(); }} className="w-10 h-10 rounded-full bg-white shadow text-gray-500 hover:text-red-500">
                            <i className="fa-solid fa-times"></i>
                        </button>
                    </div>

                    {/* Score - Hide in compact mode if keyboard is up? No, keep it small */}
                    {!isCompact && (
                        <div className="w-full max-w-lg flex justify-center mb-8">
                            <div className={`bg-white p-4 rounded-2xl shadow-sm border-l-4 flex flex-col items-center w-32 ${theme.border} ${feedback === 'correct' ? 'scale-110 transition-transform' : ''}`}>
                                <span className="text-gray-400 text-xs uppercase font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                                <span className={`text-4xl font-bold ${theme.score}`}>{score}</span>
                            </div>
                        </div>
                    )}
                    {isCompact && (
                         <div className={`absolute top-16 right-4 bg-white p-2 rounded-xl shadow-sm border-l-4 flex flex-col items-center w-20 ${theme.border} z-40`}>
                            <span className="text-gray-400 text-[10px] uppercase font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                            <span className={`text-2xl font-bold ${theme.score}`}>{score}</span>
                        </div>
                    )}

                    {/* Question Panel */}
                    <div className={`${getPanelClass(screenMode)} ${panelStyle} shadow-xl relative overflow-hidden transition-transform ${feedback === 'wrong' ? 'shake bg-red-50' : ''}`}>
                        {feedback === 'correct' && <div className="absolute inset-0 flex items-center justify-center bg-green-100 bg-opacity-90 z-10 text-green-600 text-6xl font-bold anim-pop"><i className="fa-solid fa-check"></i></div>}
                        
                        <div className={`transition-transform ${fontScale}`}>
                            <div className="text-gray-400 text-sm mb-2">‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà {score + 1}</div>
                            <div className="text-6xl font-bold text-gray-800 mb-8 flex justify-center gap-4">
                                <span>{question.a}</span>
                                <span className={theme.text}>{question.op === '*' ? '√ó' : question.op === '/' ? '√∑' : question.op}</span>
                                <span>{question.b}</span>
                                <span className="text-gray-300">=</span>
                                <span className={theme.score}>?</span>
                            </div>
                        </div>

                        {/* Input Area */}
                        {inputMode === 'numpad' ? (
                            <div className={`w-full bg-gray-100 text-center text-4xl font-bold p-4 rounded-xl border-2 border-transparent transition shadow-inner flex items-center justify-center ${isCompact ? 'h-16' : 'h-20'} ${theme.ring}`}>
                                {input}<span className="animate-pulse text-gray-400 font-light text-3xl ml-1">|</span>
                            </div>
                        ) : (
                            <form onSubmit={handleSubmit} className="w-full">
                                <input 
                                    ref={inputRef} 
                                    type="number" 
                                    pattern="[0-9]*" 
                                    inputMode="numeric" 
                                    value={input} 
                                    onChange={(e) => setInput(e.target.value)} 
                                    className={`w-full bg-gray-100 text-center text-4xl font-bold p-4 rounded-xl border-2 border-transparent focus:bg-white outline-none transition shadow-inner ${isCompact ? 'h-16' : 'h-20'} ${theme.ring}`} 
                                    placeholder="?" 
                                    autoFocus 
                                />
                                <button type="submit" className="hidden">Submit</button>
                            </form>
                        )}
                    </div>

                    {/* Numpad - Hide if compact AND keyboard mode is active? User might still want numpad in compact. Keep it. */}
                    <div className={`w-full max-w-lg grid grid-cols-3 gap-2 ${numpadStyle} pb-4`}>
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0].map((num) => (
                            <button 
                                key={num} 
                                onClick={() => handleNumpad(num)} 
                                className={`rounded-xl font-bold shadow-sm active:scale-95 transition ${num === 'C' ? 'bg-red-100 text-red-500' : 'bg-white text-gray-700 hover:bg-gray-50'} ${isCompact ? 'p-3 text-xl' : 'p-4 text-2xl'}`}
                            >
                                {num}
                            </button>
                        ))}
                        <button 
                            onClick={() => handleSubmit()} 
                            className={`rounded-xl font-bold shadow-sm active:scale-95 transition text-white ${theme.btn} ${isCompact ? 'p-3 text-xl' : 'p-4 text-2xl'}`}
                        >
                            <i className="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            );
        };

        const GameOver = ({ score, onRestart, resultMessage, isNewHighScore, mode, playSound, screenMode }) => {
            useEffect(() => { playSound('gameOver'); }, []);
            const isGodMult = mode.startsWith('god') && !mode.includes('div'); const isGodDiv = mode.startsWith('god_div'); const isBabyMode = mode === 'baby';
            const getThemeColors = () => { if (isBabyMode) return { text: 'text-pink-400', score: 'text-pink-500', btn: 'from-pink-400 to-rose-400', mainBtn: 'bg-pink-400 hover:bg-pink-500' }; if (isGodMult) return { text: 'text-orange-500', score: 'text-orange-600', btn: 'from-yellow-400 to-orange-500', mainBtn: 'bg-orange-500 hover:bg-orange-600' }; if (isGodDiv) return { text: 'text-teal-500', score: 'text-teal-600', btn: 'from-teal-400 to-cyan-500', mainBtn: 'bg-teal-500 hover:bg-teal-600' }; return { text: 'text-purple-500', score: 'text-blue-600', btn: 'from-pink-500 to-rose-500', mainBtn: 'bg-blue-500 hover:bg-blue-600' }; };
            const theme = getThemeColors();
            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 anim-pop"><div className={getPanelClass(screenMode)}><div className={`text-6xl mb-4 ${theme.text}`}><i className="fa-solid fa-flag-checkered"></i></div><h2 className="text-3xl font-bold text-gray-800 mb-2">‡∏à‡∏ö‡πÄ‡∏Å‡∏°!</h2>{isBabyMode && <div className="text-pink-400 font-bold mb-2">Baby Mode</div>}{isGodMult && <div className="text-orange-500 font-bold mb-2 text-xl">GOD MULT {mode.replace('god_', '')}</div>}{isGodDiv && <div className="text-teal-500 font-bold mb-2 text-xl">GOD DIV {mode.replace('god_div_', '')}</div>}<div className="text-xl text-gray-600 mb-4">{resultMessage || "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß"}</div>{isNewHighScore && <div className="mb-4 text-yellow-500 font-bold animate-bounce"><i className="fa-solid fa-star mr-1"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ!</div>}<div className="bg-gray-100 p-6 rounded-2xl mb-6"><div className="text-gray-500 text-sm uppercase font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div><div className={`text-6xl font-extrabold ${theme.score}`}>{score}</div></div><button onClick={() => { playSound('click'); onRestart(); }} className={`w-full text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition hover:scale-105 ${theme.mainBtn}`}>‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button></div></div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [gameState, setGameState] = useState('login'); 
            const [score, setScore] = useState(0);
            const [question, setQuestion] = useState(generateQuestion('normal')); 
            const [gameResultMsg, setGameResultMsg] = useState('');
            const [isNewHighScore, setIsNewHighScore] = useState(false);
            const [difficulty, setDifficulty] = useState('normal'); 
            const [isMuted, setIsMuted] = useState(false);
            const [inputMode, setInputMode] = useState('numpad'); 
            const [flashSettings, setFlashSettings] = useState(null);
            const [screenMode, setScreenMode] = useState(0); // 0: Normal, 1: Compact/Keyboard, 2: Full
            const [loadingLogin, setLoadingLogin] = useState(false);

            // Auth Listener
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(u => {
                    if (u) {
                         setUser(u);
                         if (gameState === 'login') setGameState('menu');
                    } else {
                         setUser(null);
                         setGameState('login');
                    }
                    setLoadingLogin(false);
                });
                return () => unsubscribe();
            }, []);

            const playSound = (type) => { if (isMuted) return; if (Sound[type]) Sound[type](); };
            
            const handleLogin = async (username) => {
                setLoadingLogin(true);
                try {
                    const result = await auth.signInAnonymously();
                    await result.user.updateProfile({ displayName: username });
                    // State update handled by listener
                } catch (error) {
                    console.error("Login Error", error);
                    alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
                    setLoadingLogin(false);
                }
            };

            const startGameSingle = (mode = 'normal') => { setDifficulty(mode); setScore(0); setIsNewHighScore(false); setQuestion(generateQuestion(mode)); setGameState('countdown'); };
            const handleStartFlashGame = (settings) => { setFlashSettings(settings); setGameState('god_flash_playing'); }; // Direct jump to component logic
            const handleCountdownFinish = () => { if (flashSettings) { setGameState('god_flash_playing'); } else { setGameState('playing_single'); } };
            
            const handleLogout = () => {
                auth.signOut();
            };

            const updateAnswer = (isCorrect) => { if (isCorrect) { const newScore = score + 1; setScore(newScore); setQuestion(generateQuestion(difficulty)); } };
            
            const saveHighScoreLocal = (finalScore) => {
                if (!user) return;
                try {
                    let modeDoc = 'normal'; 
                    if (difficulty === 'baby') modeDoc = 'baby';
                    else if (difficulty.startsWith('god_')) modeDoc = difficulty; // Matches viewMode keys
                    
                    // Firestore Logic
                    const scoreRef = db.collection('modes').doc(modeDoc).collection('scores').doc(user.uid);
                    
                    scoreRef.get().then((doc) => {
                        if (doc.exists) {
                            const currentHigh = doc.data().score;
                            if (finalScore > currentHigh) {
                                scoreRef.set({ username: user.displayName, score: finalScore, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                                setIsNewHighScore(true);
                            }
                        } else {
                            scoreRef.set({ username: user.displayName, score: finalScore, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                            setIsNewHighScore(true);
                        }
                    });
                } catch (e) { console.error("Error saving score:", e); }
            };

            const handleGameOver = () => { saveHighScoreLocal(score); setGameResultMsg("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß!"); setGameState('game_over'); };
            const resetGame = () => { setGameState('menu'); setScore(0); setIsNewHighScore(false); setFlashSettings(null); };
            const handleHome = () => { playSound('click'); resetGame(); };
            const handleBack = () => {
                playSound('click');
                if (gameState === 'god_flash_settings') setGameState('menu');
                else if (gameState === 'leaderboard') setGameState('menu');
                else if (gameState === 'god_flash_playing') setGameState('god_flash_settings'); 
                else if (gameState === 'playing_single') setGameState('menu');
                else if (gameState === 'game_over') setGameState('menu');
                else if (gameState === 'menu') handleLogout();
            };

            const showBack = gameState !== 'login';
            const showHome = gameState !== 'login';

            return (
                <div className="min-h-screen relative">
                    {gameState !== 'login' && (
                        <NavigationBar 
                            muted={isMuted} 
                            onToggleMute={() => setIsMuted(!isMuted)}
                            inputMode={inputMode} 
                            onToggleInput={() => setInputMode(prev => prev === 'numpad' ? 'keyboard' : 'numpad')}
                            onBack={handleBack}
                            onHome={handleHome}
                            screenMode={screenMode}
                            onToggleScreen={() => setScreenMode(prev => (prev + 1) % 3)}
                        />
                    )}
                    
                    {gameState === 'login' && <LoginScreen onLogin={handleLogin} playSound={playSound} loading={loadingLogin} />}
                    {gameState === 'menu' && <MainMenu onStartSingle={startGameSingle} onShowLeaderboard={() => setGameState('leaderboard')} onLogout={handleLogout} username={user?.displayName} playSound={playSound} onStartFlash={() => setGameState('god_flash_settings')} screenMode={screenMode} />}
                    {gameState === 'leaderboard' && <Leaderboard onBack={() => setGameState('menu')} currentUser={user} playSound={playSound} screenMode={screenMode} />}
                    {gameState === 'god_flash_settings' && <GodFlashSettings onStart={handleStartFlashGame} onBack={() => setGameState('menu')} playSound={playSound} screenMode={screenMode} />}
                    {gameState === 'countdown' && <Countdown onComplete={handleCountdownFinish} playSound={playSound} />}
                    {gameState === 'god_flash_playing' && flashSettings && <GodFlashGame settings={flashSettings} onQuit={resetGame} playSound={playSound} inputMode={inputMode} screenMode={screenMode} />}
                    {gameState === 'playing_single' && <GameScreen question={question} score={score} onAnswer={updateAnswer} onQuit={resetGame} timeUp={handleGameOver} mode={difficulty} playSound={playSound} inputMode={inputMode} screenMode={screenMode} />}
                    {gameState === 'game_over' && <GameOver score={score} resultMessage={gameResultMsg} onRestart={resetGame} isNewHighScore={isNewHighScore} mode={difficulty} playSound={playSound} screenMode={screenMode} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
